---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Banking Profile Wizard - MoneyPenny">
    <div class="py-12">
        <div class="mb-16 max-w-4xl mx-auto text-center">
            <h1 class="mb-4 text-5xl font-bold tracking-tight">Banking Profile Wizard</h1>
            <p class="text-xl text-gray-600 leading-relaxed">
                Upload your bank statement to calculate personalized risk limits based on your financial profile.
            </p>
        </div>

        <div class="max-w-5xl mx-auto">
            <!-- Progress Steps -->
            <div class="mb-12">
                <div class="flex items-center justify-center space-x-4">
                    <div id="step1-indicator" class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold">1</div>
                        <span class="ml-2 font-medium text-gray-700">Upload & Consent</span>
                    </div>
                    <div class="h-1 w-24 bg-gray-300" id="progress1"></div>
                    <div id="step2-indicator" class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">2</div>
                        <span class="ml-2 font-medium text-gray-400">Review Features</span>
                    </div>
                    <div class="h-1 w-24 bg-gray-300" id="progress2"></div>
                    <div id="step3-indicator" class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">3</div>
                        <span class="ml-2 font-medium text-gray-400">Apply Limits</span>
                    </div>
                </div>
            </div>

            <!-- Step 1: Upload & Consent -->
            <div id="step1" class="bg-white rounded-lg p-8 border border-gray-200 shadow-sm">
                <h2 class="text-2xl font-bold mb-4">Step 1: Connect & Consent</h2>

                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-blue-600 mt-1 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        <div>
                            <h3 class="font-semibold text-blue-900 mb-2">Your Privacy is Protected</h3>
                            <p class="text-sm text-blue-800">
                                Your statement is sealed in your <strong>BlakQube</strong> (encrypted storage).
                                We only compute feature summaries - your transactions remain private.
                            </p>
                            <ul class="mt-2 text-sm text-blue-700 space-y-1">
                                <li>✓ Purpose: Suitability assessment (QC-v1)</li>
                                <li>✓ Scope: Feature-level only (no transaction details)</li>
                                <li>✓ Retention: 12 months</li>
                                <li>✓ Revocation: Destroy tokenQube key anytime</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Bank Statements (6+ months recommended)</label>
                        <input
                            type="file"
                            id="statementFile"
                            accept=".pdf,.csv,.txt"
                            multiple
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90"
                        />
                        <p class="mt-2 text-xs text-gray-500">
                            Upload 6+ monthly statements for accurate risk profiling. Supports PDF, CSV, and TXT formats.
                        </p>
                        <div id="fileCount" class="hidden mt-2 text-xs text-gray-600">
                            <span id="fileCountText"></span>
                        </div>
                    </div>

                    <div class="flex items-start">
                        <input
                            type="checkbox"
                            id="consentCheck"
                            class="mt-1 h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                        />
                        <label for="consentCheck" class="ml-2 text-sm text-gray-700">
                            I consent to feature-level analysis of my bank statement for suitability assessment.
                            I understand my transaction details remain private and encrypted.
                        </label>
                    </div>

                    <button
                        id="uploadBtn"
                        disabled
                        class="w-full px-6 py-3 bg-primary text-white rounded-md font-semibold hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        Upload & Analyze Statement
                    </button>

                    <div id="uploadStatus" class="hidden mt-4 p-4 rounded-md"></div>
                </div>
            </div>

            <!-- Step 2: Review Features -->
            <div id="step2" class="hidden bg-white rounded-lg p-8 border border-gray-200 shadow-sm">
                <h2 class="text-2xl font-bold mb-4">Step 2: Review Your Financial Profile</h2>

                <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-md">
                    <p class="text-sm text-green-800">
                        <strong>✓ Analysis Complete</strong> - Features extracted from your statement.
                        No transaction details are stored.
                    </p>
                </div>

                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <!-- Feature Cards -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Avg Daily Surplus</div>
                        <div class="text-2xl font-bold text-gray-900" id="feat-surplus">$0</div>
                        <div class="mt-2 text-xs text-gray-500">Typical daily cashflow over <span id="monthCount">0</span> months</div>
                    </div>

                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Surplus Volatility</div>
                        <div class="text-2xl font-bold text-gray-900" id="feat-volatility">$0</div>
                        <div class="mt-2 text-xs text-gray-500">Daily cashflow variation</div>
                    </div>

                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Cash Buffer</div>
                        <div class="text-2xl font-bold text-gray-900" id="feat-buffer">0 days</div>
                        <div class="mt-2 text-xs text-gray-500">Days of expenses covered</div>
                    </div>

                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Closing Balance</div>
                        <div class="text-2xl font-bold text-gray-900" id="feat-balance">$0</div>
                        <div class="mt-2 text-xs text-gray-500">Statement end balance</div>
                    </div>
                </div>

                <!-- Risk Gauge -->
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-900 mb-3">Risk Profile Visualization</h3>
                    <div class="border border-gray-200 rounded-lg p-6 bg-gray-50">
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-600">Fees + Gas (floor)</span>
                                <span class="font-medium" id="gauge-floor">0 bps</span>
                            </div>
                            <div class="h-6 bg-gray-200 rounded-full overflow-hidden relative">
                                <div id="gauge-floor-bar" class="h-full bg-gray-400" style="width: 0%"></div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-600">Safety Buffer</span>
                                <span class="font-medium" id="gauge-safety">0 bps</span>
                            </div>
                            <div class="h-6 bg-gray-200 rounded-full overflow-hidden relative">
                                <div id="gauge-safety-bar" class="h-full bg-green-400" style="width: 0%"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-600 font-semibold">Recommended Min Edge</span>
                                <span class="font-bold text-blue-600" id="gauge-edge">0 bps</span>
                            </div>
                            <div class="h-6 bg-gray-200 rounded-full overflow-hidden relative">
                                <div id="gauge-edge-bar" class="h-full bg-blue-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button
                        id="backToStep1Btn"
                        class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400"
                    >
                        ← Back
                    </button>
                    <button
                        id="continueToStep3Btn"
                        class="flex-1 px-6 py-3 bg-primary text-white rounded-md font-semibold hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                        Continue to Apply Limits →
                    </button>
                </div>
            </div>

            <!-- Step 3: Apply Limits -->
            <div id="step3" class="hidden bg-white rounded-lg p-8 border border-gray-200 shadow-sm">
                <h2 class="text-2xl font-bold mb-4">Step 3: Apply Personalized Limits</h2>

                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
                    <p class="text-sm text-yellow-800">
                        <strong>⚠ Review Carefully</strong> - These limits will be applied to your MoneyPenny trading profile.
                    </p>
                </div>

                <div class="space-y-4 mb-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-900">Max Notional / Day</span>
                            <span class="text-2xl font-bold text-gray-900" id="limit-notional">$0</span>
                        </div>
                        <p class="text-sm text-gray-600">
                            Maximum trade size per day (35% of daily surplus, capped at 20% of balance)
                        </p>
                        <div class="mt-2 px-3 py-1 bg-gray-100 rounded text-xs text-gray-600">
                            Advisory limit - enforced by treasury
                        </div>
                    </div>

                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-gray-900">Daily Loss Limit</span>
                            <span class="text-2xl font-bold text-gray-900" id="limit-loss">0 bps</span>
                        </div>
                        <p class="text-sm text-gray-600">
                            Max tolerable daily loss (scaled by volatility, 8-40 bps range)
                        </p>
                        <div class="mt-2 px-3 py-1 bg-gray-100 rounded text-xs text-gray-600">
                            Advisory limit - enforced by treasury
                        </div>
                    </div>

                    <div class="border border-green-200 rounded-lg p-4 bg-green-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold text-green-900">Inventory Band</span>
                            <span class="text-2xl font-bold text-green-900" id="limit-inventory">0</span>
                        </div>
                        <p class="text-sm text-green-800">
                            Working capital buffer for market making (will be applied via /set_param)
                        </p>
                        <div class="mt-2 px-3 py-1 bg-green-200 rounded text-xs text-green-800 font-semibold">
                            ✓ This will be applied to your account
                        </div>
                    </div>
                </div>

                <div id="applyStatus" class="hidden mb-4 p-4 rounded-md"></div>

                <div class="flex gap-4">
                    <button
                        id="backToStep2Btn"
                        class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-md font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400"
                    >
                        ← Back
                    </button>
                    <button
                        id="applyLimitsBtn"
                        class="flex-1 px-6 py-3 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                        Apply Inventory Band to MoneyPenny
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let extractedData: any = null;

        const consentCheck = document.getElementById('consentCheck') as HTMLInputElement;
        const uploadBtn = document.getElementById('uploadBtn') as HTMLButtonElement;
        const statementFile = document.getElementById('statementFile') as HTMLInputElement;
        const uploadStatus = document.getElementById('uploadStatus') as HTMLDivElement;

        // Show file count
        statementFile?.addEventListener('change', () => {
            const count = statementFile.files?.length || 0;
            const fileCount = document.getElementById('fileCount') as HTMLDivElement;
            const fileCountText = document.getElementById('fileCountText') as HTMLSpanElement;
            if (count > 0) {
                fileCount.classList.remove('hidden');
                fileCountText.textContent = `${count} file${count > 1 ? 's' : ''} selected`;
            } else {
                fileCount.classList.add('hidden');
            }
        });

        // Enable upload button when consent is checked and files selected
        consentCheck?.addEventListener('change', () => {
            uploadBtn.disabled = !consentCheck.checked || !statementFile.files || statementFile.files.length === 0;
        });
        statementFile?.addEventListener('change', () => {
            uploadBtn.disabled = !consentCheck.checked || !statementFile.files || statementFile.files.length === 0;
        });

        // Upload handler
        uploadBtn?.addEventListener('click', async () => {
            const files = statementFile.files;
            if (!files || files.length === 0) {
                showStatus(uploadStatus, 'Please select at least one file', 'error');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Analyzing...';
            showStatus(uploadStatus, `Uploading and analyzing ${files.length} statement(s)...`, 'info');

            try {
                const formData = new FormData();
                formData.append('tenant_id', 'qripto-dev');
                Array.from(files).forEach(f => formData.append('files', f));

                const response = await fetch('http://localhost:8788/bank/bulk_extract', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const bulkData = await response.json();
                showStatus(uploadStatus, 'Aggregating multi-month analysis...', 'info');

                // Aggregate
                const aggResponse = await fetch('http://localhost:8788/profile/aggregate', {
                    method: 'POST',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: 'qripto-dev',
                        months: bulkData.months.map((m: any) => ({
                            month: m.month,
                            features: m.features,
                            proposed_overrides: m.proposed_overrides
                        }))
                    })
                });

                if (!aggResponse.ok) {
                    throw new Error('Failed to aggregate');
                }

                extractedData = await aggResponse.json();
                extractedData.monthCount = bulkData.months.length;

                showStatus(uploadStatus, `✓ Analysis complete! Analyzed ${bulkData.total_files} statements across ${bulkData.months.length} months.`, 'success');

                setTimeout(() => {
                    goToStep(2);
                    populateStep2();
                }, 1000);

            } catch (error) {
                console.error('Upload error:', error);
                showStatus(uploadStatus, `Error: ${error.message}`, 'error');
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload & Analyze Statements';
            }
        });

        // Step navigation
        document.getElementById('backToStep1Btn')?.addEventListener('click', () => goToStep(1));
        document.getElementById('continueToStep3Btn')?.addEventListener('click', () => {
            goToStep(3);
            populateStep3();
        });
        document.getElementById('backToStep2Btn')?.addEventListener('click', () => goToStep(2));

        // Apply limits
        document.getElementById('applyLimitsBtn')?.addEventListener('click', async () => {
            if (!extractedData) return;

            const applyBtn = document.getElementById('applyLimitsBtn') as HTMLButtonElement;
            const applyStatus = document.getElementById('applyStatus') as HTMLDivElement;

            applyBtn.disabled = true;
            applyBtn.textContent = 'Applying...';
            showStatus(applyStatus, 'Applying inventory band to MoneyPenny...', 'info');

            try {
                const overrides = extractedData.aggregate?.proposed_overrides || extractedData.proposed_overrides;
                const inventoryBand = overrides.inventory_band;
                const minEdge = overrides.min_edge_bps_baseline || 1.0;

                // Apply inventory_band
                const response = await fetch('http://localhost:8787/set_param', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': 'DEV_KEY_123'
                    },
                    body: JSON.stringify({
                        tenant_id: 'qripto-dev',
                        key: 'inventory_band',
                        value: inventoryBand,
                        actor: 'BankingProfileWizard'
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to apply');
                }

                // Also apply min_edge_bps
                await fetch('http://localhost:8787/set_param', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Api-Key': 'DEV_KEY_123' },
                    body: JSON.stringify({
                        tenant_id: 'qripto-dev',
                        key: 'min_edge_bps',
                        value: minEdge,
                        actor: 'BankingProfileWizard'
                    })
                });

                const result = await response.json();

                // Store applied config in localStorage for MoneyPenny to read
                localStorage.setItem('moneypenny_applied_config', JSON.stringify({
                    inventoryBand,
                    minEdge,
                    maxNotional: overrides.max_notional_usd_day,
                    dailyLossLimit: overrides.daily_loss_limit_bps,
                    appliedAt: new Date().toISOString()
                }));

                showStatus(applyStatus, `✓ Success! MoneyPenny configured with: Inventory Band=${inventoryBand}, Min Edge=${minEdge} bps. Redirecting to console...`, 'success');
                applyBtn.textContent = '✓ Applied Successfully';
                applyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                applyBtn.classList.add('bg-gray-400');

                // Redirect to MoneyPenny console after 2 seconds
                setTimeout(() => {
                    window.location.href = '/moneypenny/console';
                }, 2000);

            } catch (error) {
                console.error('Apply error:', error);
                showStatus(applyStatus, `Error: ${error.message}`, 'error');
                applyBtn.disabled = false;
                applyBtn.textContent = 'Retry Apply';
            }
        });

        function goToStep(step: number) {
            // Hide all steps
            document.getElementById('step1')?.classList.add('hidden');
            document.getElementById('step2')?.classList.add('hidden');
            document.getElementById('step3')?.classList.add('hidden');

            // Show target step
            document.getElementById(`step${step}`)?.classList.remove('hidden');

            // Update progress indicators
            updateProgressIndicators(step);
        }

        function updateProgressIndicators(activeStep: number) {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const circle = indicator?.querySelector('div');
                const label = indicator?.querySelector('span');

                if (i < activeStep) {
                    // Completed
                    circle?.classList.remove('bg-gray-300', 'bg-primary');
                    circle?.classList.add('bg-green-500');
                    label?.classList.remove('text-gray-400');
                    label?.classList.add('text-green-700');
                } else if (i === activeStep) {
                    // Active
                    circle?.classList.remove('bg-gray-300', 'bg-green-500');
                    circle?.classList.add('bg-primary');
                    label?.classList.remove('text-gray-400');
                    label?.classList.add('text-gray-700');
                } else {
                    // Inactive
                    circle?.classList.remove('bg-primary', 'bg-green-500');
                    circle?.classList.add('bg-gray-300');
                    label?.classList.remove('text-gray-700', 'text-green-700');
                    label?.classList.add('text-gray-400');
                }
            }

            // Update progress bars
            const progress1 = document.getElementById('progress1');
            const progress2 = document.getElementById('progress2');

            if (activeStep > 1) {
                progress1?.classList.remove('bg-gray-300');
                progress1?.classList.add('bg-green-500');
            }
            if (activeStep > 2) {
                progress2?.classList.remove('bg-gray-300');
                progress2?.classList.add('bg-green-500');
            }
        }

        function populateStep2() {
            if (!extractedData) return;

            const f = extractedData.aggregate || extractedData.features;
            const monthCount = extractedData.monthCount || 1;

            document.getElementById('monthCount')!.textContent = monthCount.toString();
            document.getElementById('feat-surplus')!.textContent = `$${f.avg_surplus_daily?.toFixed(2) || f.avg_daily_surplus?.toFixed(2) || '0'}`;
            document.getElementById('feat-volatility')!.textContent = `$${f.surplus_volatility_daily?.toFixed(2) || f.surplus_volatility?.toFixed(2) || '0'}`;

            // Calculate cash buffer if not provided
            const cashBuffer = f.cash_buffer_days || f.buffer_days ||
                (f.closing_balance_last && f.avg_daily_expenses ?
                    Math.floor(f.closing_balance_last / Math.abs(f.avg_daily_expenses)) :
                    (f.closing_balance && f.avg_expenses ?
                        Math.floor(f.closing_balance / Math.abs(f.avg_expenses)) : 0));
            document.getElementById('feat-buffer')!.textContent = `${cashBuffer} days`;
            document.getElementById('feat-balance')!.textContent = `$${f.closing_balance_last?.toFixed(2) || f.closing_balance?.toFixed(2) || '0'}`;

            // Update gauge from proposed overrides
            const overrides = extractedData.aggregate?.proposed_overrides || extractedData.proposed_overrides;
            const minEdge = overrides?.min_edge_bps_baseline || 1.0;
            const floorBps = 0.5; // fees + gas floor
            const safetyBps = minEdge - floorBps;

            document.getElementById('gauge-floor')!.textContent = `${floorBps} bps`;
            document.getElementById('gauge-safety')!.textContent = `${safetyBps.toFixed(2)} bps`;
            document.getElementById('gauge-edge')!.textContent = `${minEdge} bps`;

            const maxBps = 20;
            document.getElementById('gauge-floor-bar')!.style.width = `${(floorBps / maxBps) * 100}%`;
            document.getElementById('gauge-safety-bar')!.style.width = `${(safetyBps / maxBps) * 100}%`;
            document.getElementById('gauge-edge-bar')!.style.width = `${(minEdge / maxBps) * 100}%`;
        }

        function populateStep3() {
            if (!extractedData) return;

            const o = extractedData.aggregate?.proposed_overrides || extractedData.proposed_overrides;

            document.getElementById('limit-notional')!.textContent = `$${o.max_notional_usd_day?.toFixed(2) || '0'}`;
            document.getElementById('limit-loss')!.textContent = `${o.daily_loss_limit_bps || 0} bps`;
            document.getElementById('limit-inventory')!.textContent = o.inventory_band?.toFixed(2) || '0';
        }

        function showStatus(element: HTMLElement, message: string, type: 'success' | 'error' | 'info') {
            element.classList.remove('hidden', 'bg-green-50', 'bg-red-50', 'bg-blue-50', 'border-green-200', 'border-red-200', 'border-blue-200', 'text-green-800', 'text-red-800', 'text-blue-800');
            element.classList.add('border');

            if (type === 'success') {
                element.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
            } else if (type === 'error') {
                element.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
            } else {
                element.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
            }

            element.textContent = message;
        }
    </script>
</Layout>
