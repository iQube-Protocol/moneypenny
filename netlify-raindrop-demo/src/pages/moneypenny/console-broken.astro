---
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

const BASE = import.meta.env.PUBLIC_MONEYPENNY_BASE || "http://localhost:8787";
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aigent MoneyPenny QÂ¢ Trading Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
      import { createRoot } from 'https://esm.sh/react-dom@18/client';
      import { createElement as h, useState, useEffect } from 'https://esm.sh/react@18';

      // Simple components
      const ChainIcon = ({ chain }) => {
        const icons = {
          ethereum: 'âš™ï¸', arbitrum: 'ðŸ§©', base: 'ðŸŸ¦',
          polygon: 'ðŸ”º', solana: 'ðŸŸª', bitcoin: 'â‚¿'
        };
        return h('span', { className: 'text-base', title: chain }, icons[chain.toLowerCase()] || 'â›“ï¸');
      };

      const ChainChip = ({ chain, selected, onClick }) => {
        const colors = {
          ethereum: '59 130 246', arbitrum: '6 182 212', base: '59 130 246',
          polygon: '168 85 247', solana: '16 185 129', bitcoin: '245 159 0'
        };
        const color = colors[chain] || '255 255 255';
        return h('button', {
          className: `px-3 py-1.5 rounded-full text-xs border transition-all ${selected ? 'bg-opacity-20 border-opacity-40' : 'bg-white bg-opacity-5 border-white border-opacity-10'}`,
          style: { backgroundColor: selected ? `rgba(${color}, 0.2)` : undefined, borderColor: `rgba(${color}, 0.3)` },
          onClick
        }, [
          h(ChainIcon, { chain, key: 'icon' }),
          h('span', { className: 'ml-1 capitalize', key: 'label' }, chain)
        ]);
      };

      function Console() {
        const [connected, setConnected] = useState(false);
        const [mode, setMode] = useState('SIM');
        const [chains, setChains] = useState(['ethereum', 'arbitrum', 'base', 'polygon', 'solana']);
        const [edge, setEdge] = useState(0);
        const [floor, setFloor] = useState(0.5);
        const [fills, setFills] = useState([]);
        const [quotes, setQuotes] = useState([]);
        const [capture, setCapture] = useState([]);
        const [qcentEarned, setQcentEarned] = useState(0);
        const [es, setEs] = useState(null);

        const toggleChain = (c) => {
          if (chains.includes(c)) {
            if (chains.length > 1) setChains(chains.filter(x => x !== c));
          } else {
            setChains([...chains, c]);
          }
        };

        const connect = () => {
          if (es) es.close();
          setConnected(false);

          const qs = new URLSearchParams();
          qs.set('k', 'DEV_KEY_123');
          if (chains.length) qs.set('chains', chains.join(','));

          const url = `${BASE}/sim/stream?${qs.toString()}`;
          const newEs = new EventSource(url);

          newEs.onopen = () => setConnected(true);
          newEs.onerror = () => setConnected(false);
          newEs.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.status === 'QUOTE') {
              setEdge(msg.edge_bps || 0);
              setFloor(msg.floor_bps || 0.5);
              setQuotes(prev => [msg, ...prev].slice(0, 20));
            }
            if (msg.status === 'FILL') {
              setFills(prev => [msg, ...prev].slice(0, 40));
            }
            if (msg.status === 'P&L') {
              setCapture(prev => [...prev.slice(-120), msg.capture_bps || 0]);
              if (msg.capture_bps && msg.notional_usd) {
                const qc = (msg.capture_bps / 10000) * msg.notional_usd / (msg.peg_usd || 0.01);
                setQcentEarned(prev => +(prev + qc).toFixed(2));
              }
            }
          };
          setEs(newEs);
        };

        useEffect(() => {
          connect();
          return () => es?.close();
        }, [chains]);

        return h('div', { className: 'space-y-6' }, [
          // Header
          h('div', { key: 'header' }, [
            h('h1', { className: 'text-2xl font-bold' }, 'Aigent MoneyPenny QÂ¢ Trading Console'),
            h('p', { className: 'text-sm text-gray-400 mt-1' }, 'QriptoCENT (QÂ¢) micro-slippage trading agent. Get quotes, submit intents, and monitor execution.')
          ]),

          // Chain portfolio selector
          h('section', { key: 'portfolio', className: 'bg-white bg-opacity-5 rounded-2xl p-4' }, [
            h('div', { className: 'flex items-center justify-between flex-wrap gap-3' }, [
              h('span', { className: 'text-xs text-gray-400' }, 'Chain Portfolio:'),
              h('div', { className: 'flex gap-2 flex-wrap' },
                ['ethereum', 'arbitrum', 'base', 'polygon', 'solana'].map(c =>
                  h(ChainChip, { key: c, chain: c, selected: chains.includes(c), onClick: () => toggleChain(c) })
                )
              ),
              h('div', { className: 'flex gap-2' }, [
                h('span', {
                  className: `text-xs px-3 py-1 rounded-full ${connected ? 'bg-emerald-500 bg-opacity-20 text-emerald-400' : 'bg-rose-500 bg-opacity-20 text-rose-400'}`
                }, connected ? 'ðŸŸ¢ Connected' : 'âš« Disconnected')
              ])
            ])
          ]),

          // Stats cards
          h('section', { key: 'stats', className: 'grid lg:grid-cols-3 gap-4' }, [
            // Edge Gauge placeholder
            h('div', { className: 'bg-white bg-opacity-5 rounded-2xl p-4' }, [
              h('div', { className: 'text-sm font-medium mb-2' }, 'Edge Gauge'),
              h('div', { className: 'text-xs text-gray-400' }, `Floor: ${floor.toFixed(2)} bps Â· Now: ${edge.toFixed(2)} bps`)
            ]),
            // QÂ¢ Accumulated
            h('div', { className: 'bg-white bg-opacity-5 rounded-2xl p-4' }, [
              h('div', { className: 'text-sm font-medium mb-2' }, 'QÂ¢ Accumulated'),
              h('div', { className: 'text-3xl font-semibold' }, `${qcentEarned.toLocaleString()} QÂ¢`),
              h('div', { className: 'text-xs text-gray-400 mt-1' }, 'From realized capture during this session.')
            ]),
            // Inventory
            h('div', { className: 'bg-white bg-opacity-5 rounded-2xl p-4' }, [
              h('div', { className: 'text-sm font-medium mb-2' }, 'Inventory Band'),
              h('div', { className: 'h-2 bg-gray-700 rounded relative' },
                h('div', { className: 'h-2 bg-emerald-400 rounded', style: { width: '40%' } })
              ),
              h('div', { className: 'text-xs text-gray-400 mt-1' }, 'Working QÂ¢ within target band.')
            ])
          ]),

          // Quotes table
          h('section', { key: 'quotes', className: 'bg-white bg-opacity-5 rounded-2xl p-4' }, [
            h('div', { className: 'text-sm font-medium mb-2' }, 'Recent Quotes'),
            h('div', { className: 'overflow-x-auto' },
              h('table', { className: 'w-full text-xs' }, [
                h('thead', { className: 'border-b border-gray-700' },
                  h('tr', {}, [
                    h('th', { className: 'text-left p-2' }, 'Chain'),
                    h('th', { className: 'text-left p-2' }, 'Pair'),
                    h('th', { className: 'text-right p-2' }, 'Floor (bps)'),
                    h('th', { className: 'text-right p-2' }, 'Edge (bps)'),
                    h('th', { className: 'text-right p-2' }, 'Time')
                  ])
                ),
                h('tbody', {},
                  quotes.map((q, i) =>
                    h('tr', { key: i, className: 'border-b border-gray-800' }, [
                      h('td', { className: 'p-2' }, [
                        h(ChainIcon, { chain: q.chain || '', key: 'icon' }),
                        h('span', { className: 'ml-2 capitalize' }, q.chain || '')
                      ]),
                      h('td', { className: 'p-2' }, q.pair || 'QCT/USDC'),
                      h('td', { className: 'p-2 text-right' }, (q.floor_bps || 0).toFixed(2)),
                      h('td', { className: `p-2 text-right ${(q.edge_bps || 0) > 0 ? 'text-emerald-400' : 'text-rose-400'}` }, (q.edge_bps || 0).toFixed(2)),
                      h('td', { className: 'p-2 text-right text-gray-400' }, new Date(q.ts).toLocaleTimeString())
                    ])
                  )
                )
              ])
            )
          ]),

          // Fills and capture
          h('section', { key: 'fills', className: 'grid md:grid-cols-2 gap-4' }, [
            h('div', { className: 'bg-white bg-opacity-5 rounded-2xl p-4' }, [
              h('div', { className: 'text-sm font-medium mb-2' }, 'Micro Fills'),
              h('div', { className: 'space-y-1 h-64 overflow-y-auto' },
                fills.map((f, i) =>
                  h('div', { key: i, className: 'flex items-center gap-2 text-xs p-2 rounded bg-white bg-opacity-5' }, [
                    h('span', {
                      className: `px-2 py-0.5 rounded-full ${f.side === 'BUY' ? 'bg-emerald-500 bg-opacity-20 text-emerald-400' : 'bg-rose-500 bg-opacity-20 text-rose-400'}`
                    }, f.side),
                    f.chain && h(ChainIcon, { chain: f.chain }),
                    h('span', { className: 'font-mono' }, `${f.qty_qct?.toFixed(2)} QÂ¢`),
                    h('span', { className: 'font-mono text-gray-400' }, `@ $${f.price_usdc?.toFixed(5)}`),
                    h('span', { className: 'text-gray-500 ml-auto' }, new Date(f.ts).toLocaleTimeString())
                  ])
                )
              )
            ]),
            h('div', { className: 'bg-white bg-opacity-5 rounded-2xl p-4' }, [
              h('div', { className: 'text-sm font-medium mb-2' }, 'Capture (bps)'),
              h('div', { className: 'text-xs text-gray-400' }, capture.length ? `Last: ${capture[capture.length - 1]?.toFixed(2)} bps` : 'No data yet')
            ])
          ])
        ]);
      }

      // Mount
      const root = createRoot(document.getElementById('app'));
      root.render(h(Console));
    </script>
  </head>
  <body class="bg-slate-900 text-slate-200">
    <Header />
    <main class="max-w-7xl mx-auto p-6">
      <div id="app"></div>
    </main>
    <Footer />
  </body>
</html>
